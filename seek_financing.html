<!doctype html>
<html>
<head>
<meta content="webkit" name="renderer" />
	<meta charset="utf-8">
	<title>寻求融资</title>
	<!--basis-->
	{(dn_basis.html)}
</head>
<style>
		.red{
			color:red
		}
</style>

<body>
{(header.html)}
<div class="container">

	<form  action="#" id="form" enctype="multipart/form-data">
		<div class="seek_financing">
			<div class="seek_financing_tit">提交项目</div>
			<ul>
				<li>
					<div class="seek_financing_l"><span class="seek_financing_two">项目名称</span><span class="seek_financing_one">*</span></div>
					<div class="seek_financing_r">
						<input class="seek_financing_input" name="projName"  required data-rule-length20="true"  maxlength="20"  data-msg-length20="<span class='dn_ico dn_ico_error'></span>不超过20个字"  placeholder="请输入公司核心产品名称，不超过20个字">
					</div>
				</li>
				<li>
					<div class="seek_financing_l"><span class="seek_financing_two">所在地区</span><span class="seek_financing_one">*</span></div>
					<div class="seek_financing_r">
						<select class="seek_financing_select " name="projDistrictId" data-item="parent" data-field="district"  data-rule-select="true" data-msg-select="<font color=red>*</font>必选项" >
							<option  selected = "selected" disabled="true">选择所在省/市</option>
						</select>
						<select class="seek_financing_select  seek_financing_select_lef" data-item="son" name="projSubDistrictId" data-rule-select="true" data-msg-select="<font color=red>*</font>必选项" >
							<option selected= "selected" disabled="true">选择所在市/区</option>
						</select>
					</div>
					<input type="hidden" name="projDistrict">
					<input type="hidden" name="projSubDistrict">
				</li>
				<li>
					<div class="seek_financing_l"><span class="seek_financing_two">项目介绍</span><span class="seek_financing_one">*</span></div>
					<div class="seek_financing_r">
						<textarea class="seek_financing_textarea" name="projDesc" required maxlength="1000" placeholder="产品描述、用户群体、项目愿景、竞争对手等方面详细描述，不超过1000个字"  required data-rule-length1000="true" data-msg-length1000="<span class='dn_ico dn_ico_error'></span>不超过1000个字"></textarea>
					</div>
				</li>
				<li>
					<div class="seek_financing_l"><span class="seek_financing_two">联系人姓名</span><span class="seek_financing_one">*</span></div>
					<div class="seek_financing_r">
						<input class="seek_financing_input" name="projLinkman" required  maxlength="50"  placeholder="联系人姓名"  required data-rule-length50="true" data-msg-length50="<span class='dn_ico dn_ico_error'></span>不超过50个字">
					</div>
				</li>
				<li>
					<div class="seek_financing_l"><span class="seek_financing_two">联系人电话</span><span class="seek_financing_one">*</span></div>
					<div class="seek_financing_r">
						<input class="seek_financing_input" name="projLinktel" required  data-rule-phone="true"   maxlength="40" placeholder="联系人电话"  data-msg-phone="<span class='dn_ico dn_ico_error'></span>联系电话格式不正确">
					</div>
				</li>
				<li>
					<div class="seek_financing_l"><span class="seek_financing_two">商业计划书</span><span class="seek_financing_one">*</span></div>
					<div class="seek_financing_r">

						<div class="seek_put">
							<div class="logo_posi"><input type="file" name="file" id="projPb" style="opacity: 0; width: 140px;height: 50px;"/>
								<input type="hidden" name="projPb">
							</div>
							<span class="dn_ico dn_ico_seek_pur1"></span>上传文件

						</div>
						<span class="tit_span" id="projPbName">上传商业计划书，文件大小请限制在25M之内</span>
					</div>
				</li>

				<li class="seek_show_on">
					<div class="seek_financing_l"><span class="seek_financing_two">项目LOGO</span></div>
					<div class="seek_financing_r">
						<div class="seek_put">
							<div class="logo_posi"><input type="file" name="file" id="projLogo" style="opacity: 0; width: 140px; height: 50px;">
								<input type="hidden" name="projLogo"></div>
							<span class="dn_ico dn_ico_seek_pur2"></span>上传logo
						</div>
						<span class="tit_span" id="projLogoName">请上传项目logo，建议图片尺寸300*300 文件大小请限制在500k内</span>
					</div>
				</li>
				<li class="seek_show_on">
					<div class="seek_financing_l"><span class="seek_financing_two">所属领域</span></div>
					<input type="hidden" name="projIndustry">
					<input type="hidden" name="projSubIndustry">
					<div class="seek_financing_r">
						<select class="seek_financing_select" name="projIndustryId" data-item="parent" data-field="industry" >
							<option  selected= "selected" disabled="true" >选择一级行业</option>
						</select>
						<select class="seek_financing_select seek_financing_select_lef" name="projSubIndustryId" data-item="son" >
							<option  selected= "selected" disabled="true" >选择二级行业</option>
						</select>
					</div>
				</li>
				<li class="seek_show_on">
					<div class="seek_financing_l"><span class="seek_financing_two">产品网址</span></div>
					<div class="seek_financing_r">
						<input class="seek_financing_input" name="projWebaddress" placeholder="产品网址" data-rule-url="true" data-msg-url="<font color=red>*</font>网址格式不正确">
					</div>
				</li>
				<li class="seek_show_on">
					<div class="seek_financing_l"><span class="seek_financing_two">公司全称</span></div>
					<div class="seek_financing_r">
						<input class="seek_financing_input" name="projCompName" maxlength="40" placeholder="请输入工商注册公司全称，不超过40个字">
					</div>
				</li>
				<li class="seek_show_on">
					<div class="seek_financing_l"><span class="seek_financing_two">公司地址</span></div>
					<div class="seek_financing_r">
						<input class="seek_financing_input" name="projCompAddr"  maxlength="500"   placeholder="公司地址">
					</div>
				</li>
				<li class="seek_show_on">
					<div class="seek_financing_l"><span class="seek_financing_two">融资轮次</span></div>
					<input type="hidden" name="projRound">
					<div class="seek_financing_r">
						<select class="seek_financing_select" name="projRoundId"  data-item="parent" data-field="round" >
							<option  selected= "selected" disabled="true" >选择融资轮次</option>
						</select>
					</div>
				</li>
				<li class="seek_show_on">
					<div class="seek_financing_l"><span class="seek_financing_two">融资金额</span></div>
					<div class="seek_financing_r">
						<input class="seek_financing_input" name="projMoney" placeholder="请输入您需要的融资金额"  data-rule-money="true" data-msg-money="请输入数字，最多可填写4位小数">
						<div class="seek_financing_absolute">万元　(人民币)</div>
					</div>
				</li>
				<li class="seek_show_on">
					<div class="seek_financing_l"><span class="seek_financing_two">出让股份</span></div>
					<div class="seek_financing_r">
						<input class="seek_financing_input" name="projStock" placeholder="请输入出让的股份（百分比）" data-rule-stock="true" data-msg-stock="请输入0-100之间的数字，最多可填写4位小数" >
						<div class="seek_financing_absolute">%</div>
					</div>
				</li>
			</ul>
			<div class="seek_show"><span class="seek_show_open"><span class="seek_show_blue">完善信息　</span>可以加速融资进度哦~<span class="dn_ico dn_ico_seek_open"></span></span><span class="seek_show_off"><span class="seek_show_blue">收起</span><span class="dn_ico dn_ico_seek_off"></span></span></div>
			<div class="seek_submit" id="save-btn">提交项目</div>
		</div>
	</form>
</div>
{(dn_foot.html)}
</body>
<script src="js/jquery.validate.js" type="text/javascript"></script>
<script src="js/messages_zh.min.js" type="text/javascript"></script>
<script type="text/javascript" src="js/jquery.ui.widget.js"></script>
<script type="text/javascript" src="js/jquery.fileupload.js"></script>
<script type="text/javascript" src="js/jquery.fileupload-validate.js"></script>
<script>
	$(function(){
		//表单清空
	 	$("#form")[0].reset();
	 	//表单验证
		$("#form").validate({
			submitHandler: function() {
				var pb = $("input[name='projPb']").val();
				if(!pb){
					$("#projPbName").addClass("red")
					return;
				}
				save()
				//验证通过后 的js代码写在这里
			}
		})
	})
	//验证手机号
    jQuery.validator.addMethod("phone", function (value, element) {
     var phone = /^[\+\-\(\)0-9]{0,40}$/;
   	return this.optional(element) || (phone.test(value));
    }, "手机格式不对");

	//验证长度
	jQuery.validator.addMethod("length20", function (value, element) {
		var verify_20 = /^(?!.{20}|^\s*$)/;
		return this.optional(element) || (verify_20.test(value));
	}, "");
	
	//验证长度
	jQuery.validator.addMethod("length50", function (value, element) {
		var verify_50 = /^(?!.{50}|^\s*$)/;
		return this.optional(element) || (verify_50.test(value));
	}, "");
	//验证长度
	jQuery.validator.addMethod("length1000", function (value, element) {
		var verify_1000 = /^(?!.{1000}|^\s*$)/;
		return this.optional(element) || (verify_1000.test(value));
	}, "");

	//验证select
	jQuery.validator.addMethod("select", function (value, element) {
		if(!value){
			return false;
		}else{
			return true;
		}
	}, "");


	//验证长度
	jQuery.validator.addMethod("url", function (value, element) {
		var regex = /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/;
		return this.optional(element) || (regex.test(value));
	}, "");


	//验证长度
	jQuery.validator.addMethod("money", function (value, element) {
		var regex = /^(\d(\.\d{1,4})?|([1-9][0-9]{1,8})(\.\d{1,4})?)$/;;
		return this.optional(element) || (regex.test(value));
	}, "");

	//验证整数位
	jQuery.validator.addMethod("intlength", function (value, element) {
		var intnum ;
		if(value.indexOf(".")>=0){
			intnum = value.split(".")[0].length;
		}else{
			intnum = value.length;
		}
		var length = $.isArray( intnum ) ? intnum.length : this.getLength($.trim(intnum), element);
		return this.optional(element) || (length <= 9);
	}, "");

	//验证长度
	jQuery.validator.addMethod("stock", function (value, element, param) {
		var regex = /^100$|^(\d|[1-9]\d)(\.\d{1,4})*$/;
		return this.optional(element) || (regex.test(value));
	}, "");

	$("input[name='projMoney']").bind("input propertychange", function() {
		var value=$(this).val();
		var intnum ;
		var decimalnum;
		if(value.indexOf(".")>=0){
			intnum = value.split(".")[0].length;
			decimalnum = value.split(".")[1].length;
		}else{
			intnum = value.length;
		}
		if(intnum>9){
			$(this).val($(this).val().substr(0,9));
			return;
		}
		if(decimalnum>4){
			$(this).val($(this).val().substr(0,14));
		}
	});

	$.fn.serializeJson = function(){
		var data = {};
		var array = this.serializeArray();
		$.each(array,function(){
			data[this.name]=this.value.replace(/(^\s+)|(\s+$)/g,"");
		})
		return data;
	}

	$('.seek_show_open').click(function(event){
		$(this).hide();
		$('.seek_show_on').show();
		$('.seek_show_off').show();
	})
	$('.seek_show_off').click(function(event){
		$(this).hide();
		$('.seek_show_on').hide();
		$('.seek_show_open').show();
	})

	$("#projLogo").fileupload({
		url:platformUrl.fileUpload,
		formData:{},
		add: function (e, data) {
			var acceptFileTypes = /\/(jpg|jpeg|png|gif)$/i;
			if(data.originalFiles[0]['type'].length && !acceptFileTypes.test(data.originalFiles[0]['type'])) {
				$("#projLogoName").html("<font color='red'>*您的文件格式不正确</font>")
				return;
			}
			if(data.files[0].size > 500*1024*1024){
				$("#projLogoName").html("<font color='red'>*您的文件大小超过限制，请控制在500KB之内</font>")
				return;
			}
			$("#projLogoName").html(data.files[0].name);
            data.submit();
        },
        messages: {
			maxFileSize: 'File exceeds maximum allowed size of 5b'
		},
		done: function (e, data) {
			if(data.result.message == 'OK')
			{
				$("input[name='projLogo']").val(data.result.data)
			}
			else
			{
				$("#projLogoName").text(data.result.message);
			}
		}
	});
	$("#projPb").fileupload({
		url:platformUrl.fileUpload,
		formData:{},
		add: function (e, data) {
			if(data.files[0].size > 25*1024*1024){
				$("#projPbName").text("上传商业计划书，文件大小请限制在25M之内")
				$("#projPbName").addClass("red")
				return;
			}
			$("#projPbName").text("正在上传文件...")
			$("#projPbName").removeClass("red")
            data.submit();
        },
		done: function (e, data) {
			if(data.result.message == 'OK')
			{
				$("#projPbName").removeClass("red")
				$("#projPbName").text(data.files[0].name);
				$("input[name='projPb']").val(data.result.data)
			}
			else
			{
				$("#projPbName").text(data.result.message);
			}
		}
	});
</script>
<script>
function save(){
		var projDistrict =  $("select[name='projDistrictId']").find("option:selected").text();
		var projSubDistrict =  $("select[name='projSubDistrictId']").find("option:selected").text();
		$("input[name='projDistrict']").val(projDistrict)
		$("input[name='projSubDistrict']").val(projSubDistrict)

		if($("select[name='projIndustryId']").val()){
			var projIndustry =  $("select[name='projIndustryId']").find("option:selected").text();
			$("input[name='projIndustry']").val(projIndustry)
		}

		if($("select[name='projSubIndustryId']").val()){
			var projSubIndustry =  $("select[name='projSubIndustryId']").find("option:selected").text();
			$("input[name='projSubIndustry']").val(projSubIndustry)
		}

		if($("select[name='projRoundId']").val()){
			var projRound =  $("select[name='projRoundId']").find("option:selected").text();
			$("input[name='projRound']").val(projRound)
		}
		var url =detail.insertProject
			var data = JSON.stringify($("#form").serializeJson());
			$.ajax({
				type: "POST",
				url:url,
				contentType:'application/json;charset=UTF-8',
				data:data,
				success:function(data){
					if(data.message == 'OK')
					{
						layer.msg("项目提交成功,我们会尽快联系您~",0,function(){
							location.href="index.html"
						});

					}
					else
					{
						layer.msg("项目提交失败,请稍后再试!");
					}
				}
			})
}
$('body').delegate('#save-btn','click', function(event){
 	event.stopPropagation();
	$("#form").submit();
})
	var list ={} ;
	sendGetRequest(platformUrl.allQuery,function(data){
		list["district"] = data.data.district[0].children;
		list["industry"] = data.data.industry;
		list["round"] = data.data.round;
	})
	var parents = $("select[data-item='parent']");
	$.each(parents,function(){
		var parent = $(this);
		var field =  parent.attr("data-field");
		var data  = list[field];
		var html = ""
		$.each(data,function(i,e){
			html += "<option value ="+e.id+" >"+e.name+"</option>"
		})
		parent.append(html);
	})

	$("select[name='projDistrictId']").change(function(){
		var parent = $(this);
		var son =$("select[name='projSubDistrictId']")
		getOption(parent,son)
	})

	$("select[name='projIndustryId']").change(function(){
		var parent = $(this);
		var son =$("select[name='projSubIndustryId']")
		getOption(parent,son)
	})

	function getOption(parent,son){
		// 先清空二级
		son.empty();
		var field=parent.attr("data-field")
		var index;
		if(parent[0].selectedIndex ==0 ){
			index = 0;
		}else{
			index= parent[0].selectedIndex-1
		}
		var parentData = list[field][index];
		var data =parentData.children;
		var html = ""
		son.val(data[0].id)
		$.each(data,function(i,e){
			html += "<option value ="+e.id+" >"+e.name+"</option>"
		})
		son.append(html);
		son.click();
	}
</script>
</html>
