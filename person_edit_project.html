<!doctype html>
<html>
<head>
<meta content="webkit" name="renderer" />
	<meta charset="utf-8">
	<title>编辑项目</title>
	<!--basis-->
	{(dn_basis.html)}
</head>
<style>
		.red{
			color:red
		}
</style>

<body>
{(header.html)}
<div class='person-center-container projectEidtContaier clearfix'>
	{(person_center_header.html)}
	<form  action="#" id="form" enctype="multipart/form-data" class='person-right fl person-edit-project-content'>
		<div>
			<div class="seek_financing_tit personEditTitle">编辑项目</div>
			<ul class='clearfix person_edit_ul'>
				<li>
					<div class="seek_financing_l seek_finacing_left"><span class="seek_financing_two">项目名称</span><span class="seek_financing_one">*</span></div>
					<div class="seek_financing_r person_finacing_right">
						<input class="seek_financing_input editRequireInput" name="projectName"  value required data-rule-length20="true"  maxlength="20"  data-msg-length20="<span class='dn_ico dn_ico_error'></span>不超过20个字"  placeholder="请输入公司核心产品名称，不超过20个字">
					</div>
				</li>
				<input type="hidden" name="projectId">
				<input type="hidden" name="isClaim">
				<input type="hidden" name="userId">
				<li>
					<div class="seek_financing_l seek_finacing_left"><span class="seek_financing_two">所在地区</span><span class="seek_financing_one">*</span></div>
					<div class="seek_financing_r person_finacing_right">
					   <div class='fl'>
							<select class="seek_financing_select " name="area1" data-item="parent" data-field="district"  data-rule-select="true" data-msg-select="<font color=red>*</font>必选项" >
								<option  selected = "selected" disabled="true">选择所在省/市</option>
							</select>
						</div>
						<div class='fr'>
							<select class="seek_financing_select  seek_financing_select_lef" data-item="son" name="area2" data-rule-select="true" data-msg-select="<font color=red>*</font>必选项" >
								<option selected= "selected" disabled="true">选择所在市/区</option>
							</select>
						</div>
					</div>
					<input type="hidden" name="area1Name">
					<input type="hidden" name="area2Name">
				</li>
				<li>
					<div class="seek_financing_l seek_finacing_left"><span class="seek_financing_two">项目介绍</span><span class="seek_financing_one">*</span></div>
					<div class="seek_financing_r person_finacing_right">
						<textarea class="seek_financing_textarea editRequireInput" name="projectDescription" required maxlength="1000" placeholder="产品描述、用户群体、项目愿景、竞争对手等方面详细描述，不超过1000个字"  required data-rule-length1000="true" data-msg-length1000="<span class='dn_ico dn_ico_error'></span>不超过1000个字"></textarea>
					</div>
				</li>
				<li class='personEditLinkName'>
					<div class="seek_financing_l seek_finacing_left"><span class="seek_financing_two">联系人姓名</span><span class="seek_financing_one">*</span></div>
					<div class="seek_financing_r person_finacing_right">
						<input class="seek_financing_input editRequireInput" name="linkName" required  maxlength="50"  placeholder="联系人姓名"  required data-rule-length50="true" data-msg-length50="<span class='dn_ico dn_ico_error'></span>不超过50个字">
					</div>
				</li>
				<li class='personEditLinkName'>
					<div class="seek_financing_l seek_finacing_left"><span class="seek_financing_two">联系人电话</span><span class="seek_financing_one">*</span></div>
					<div class="seek_financing_r person_finacing_right">
						<input class="seek_financing_input editRequireInput" name="linkPhone1" required  data-rule-phone="truxe"   maxlength="40" placeholder="联系人电话"  data-msg-phone="<span class='dn_ico dn_ico_error'></span>联系电话格式不正确">
					</div>
				</li>
				<li class='personEditLinkName'>
					<div class="seek_financing_l seek_finacing_left"><span class="seek_financing_two">商业计划书</span><span class="seek_financing_one">*</span></div>
					<div class="seek_financing_r person_finacing_right">

						<div class="seek_put person-upload-bp">
							<div class="logo_posi"><input type="file" name="file" id="projPb" style="opacity: 0; width: 140px;height: 50px;"/>
								<input type="hidden" name="fileName">
								<input type="hidden" name="fileSize">
								<input type="hidden" name="fileUrl">
								<input type="hidden" name="fileKey">
							</div>
							<span class="dn_ico dn_ico_seek_pur1 personUploadPic"></span>上传文件

						</div>
						<span class="tit_span" id="projPbName">上传商业计划书，文件大小请限制在25M之内</span>
					</div>
				</li>

				<li class="seek_show_on seek_show_block">
					<div class="seek_financing_l seek_finacing_left"><span class="seek_financing_two">项目LOGO</span></div>
					<div class="seek_financing_r person_finacing_right">
						<div class="seek_put">
							<div class="logo_posi"><input type="file" name="file" id="projLogo" style="opacity: 0; width: 140px; height: 50px;">
								<input type="hidden" name="projectLogo">
							<span class="dn_ico dn_ico_seek_pur2"></span>上传logo
						</div>
						</div>
						<span class="tit_span" id="projLogoName">请上传项目logo，建议图片尺寸300*300 文件大小请限制在500k内</span>
					</div>
				</li>
				<li class="seek_show_on seek_show_block seeShowLeft">
					<div class="seek_financing_l seek_finacing_left"><span class="seek_financing_two">所属领域</span></div>
					<input type="hidden" name="industry1Name">
					<input type="hidden" name="industry2Name">
					<div class="seek_financing_r person_finacing_right">
						<select class="seek_financing_select" name="industry1" data-item="parent" data-field="industry" >
							<option  selected= "selected" disabled="true" >选择一级行业</option>
						</select>
						<select class="seek_financing_select seek_financing_select_lef" name="industry2" data-item="son" >
							<option  selected= "selected" disabled="true" >选择二级行业</option>
						</select>
					</div>
				</li>
				<li class="seek_show_on seek_show_block seeShowLeft">
					<div class="seek_financing_l seek_finacing_left"><span class="seek_financing_two">产品网址</span></div>
					<div class="seek_financing_r person_finacing_right">
						<input class="seek_financing_input" name="productUrl" maxlength="100" placeholder="产品网址" data-rule-url="true" data-msg-url="<font color=red>*</font>网址格式不正确">
					</div>
				</li>
				<li class="seek_show_on seek_show_block seeShowLeft">
					<div class="seek_financing_l seek_finacing_left"><span class="seek_financing_two">公司全称</span></div>
					<div class="seek_financing_r person_finacing_right">
						<input class="seek_financing_input" name="companyName" maxlength="50" placeholder="请输入工商注册公司全称，不超过50个字">
					</div>
				</li>
				<li class="seek_show_on seek_show_block editShowLeft">
					<div class="seek_financing_l seek_finacing_left"><span class="seek_financing_two">公司地址</span></div>
					<div class="seek_financing_r person_finacing_right">
						<input class="seek_financing_input" name="companyAdd"  maxlength="200"   placeholder="公司地址">
					</div>
				</li>
				<li class="seek_show_on seek_show_block editShowLeft">
					<div class="seek_financing_l seek_finacing_left"><span class="seek_financing_two">融资轮次</span></div>
					<input type="hidden" name="projectLunciTxt">
					<div class="seek_financing_r person_finacing_right">
						<select class="seek_financing_select" name="projectLunci"  data-item="parent" data-field="round" >
							<option  selected= "selected" disabled="true" >选择融资轮次</option>
						</select>
					</div>
				</li>
				<li class="seek_show_on seek_show_block editShowLeft">
					<div class="seek_financing_l seek_finacing_left"><span class="seek_financing_two">融资金额</span></div>
					<div class="seek_financing_r person_finacing_right">
						<input class="seek_financing_input" name="projectContribution" placeholder="请输入您需要的融资金额"  data-rule-money="true" data-msg-money="请输入数字，最多可填写4位小数">
						<div class="seek_financing_absolute personInputUnit">万元　(人民币)</div>
					</div>
				</li>
				<li class="seek_show_on seek_show_block editShowLeft">
					<div class="seek_financing_l seek_finacing_left"><span class="seek_financing_two">出让股份</span></div>
					<div class="seek_financing_r person_finacing_right">
						<input class="seek_financing_input" name="projectShareRatio" placeholder="请输入出让的股份（百分比）" data-rule-stock="true" data-msg-stock="请输入0-100之间的数字，最多可填写4位小数" >
						<div class="seek_financing_absolute personInputUnit">%</div>
					</div>
				</li>
			</ul>
			<div class='person-edit-content'><span class='person_edit_return' onclick="back()">返回</span><span class='person-edit-save' id="save-btn">保存</span></div>
		</div>
	</form>

</div>
{(dn_foot.html)}
</body>
<script src="js/person_center_foot.js"></script>
<script src="js/jquery.validate.js" type="text/javascript"></script>
<script src="js/messages_zh.min.js" type="text/javascript"></script>
<script type="text/javascript" src="js/jquery.ui.widget.js"></script>
<script type="text/javascript" src="js/jquery.fileupload.js"></script>
<script type="text/javascript" src="js/jquery.fileupload-validate.js"></script>
<script type="text/javascript" src="layer/layer.js"></script>

<script>
	$(function(){
		//表单清空
	 	//$("#form")[0].reset();
	 	//表单验证
	 	//debugger
		$("#form").validate({
			submitHandler: function() {
				var pb = $("input[name='fileName']").val();
				if(!pb){
					$("#projPbName").addClass("red");
					$('.plllslslslslslslslslslerson-upload-bp').addClass('uploadBtnDanger');
					//$('.personUploadPic').addClass('uploadSpanPic')
					return;
				}
				save()
				//验证通过后的js代码写在这里
			},
			onfocusout:function(element){
				$(element).valid();
			},
			onfocusin:function(){

			}
		})
	})

	//单独进行验证，高亮
	$('.editRequireInput').blur(function(){
		var _this = $(this);
		_this.addClass('inputDanger');
		_this.addClass('invalid');
		if(_this.hasClass('valid')){
			_this.removeClass('inputDanger');
			_this.removeClass('invalid');
		}
	});
	$('.editRequireInput').focus(function(){
		var _this = $(this);
		_this.removeClass('inputDanger');
		_this.removeClass('invalid');
	});



	//验证手机号
    jQuery.validator.addMethod("phone", function (value, element) {
     var phone = /^[\+\-\(\)0-9]{0,40}$/;
   	return this.optional(element) || (phone.test(value));
    }, "手机格式不对");

	//验证长度
	jQuery.validator.addMethod("length20", function (value, element) {
		var verify_20 = /^(?!.{21}|^\s*$)/;
		return this.optional(element) || (verify_20.test(value));
	}, "");

	//验证长度
	jQuery.validator.addMethod("length50", function (value, element) {
		var verify_50 = /^(?!.{51}|^\s*$)/;
		return this.optional(element) || (verify_50.test(value));
	}, "");
	//验证长度
	jQuery.validator.addMethod("length1000", function (value, element) {
		var verify_1000 = /^(?!.{1001}|^\s*$)/;
		return this.optional(element) || (verify_1000.test(value));
	}, "");

	//验证select
	jQuery.validator.addMethod("select", function (value, element) {
		if(!value){
			return false;
		}else{
			return true;
		}
	}, "");


	//验证长度
	jQuery.validator.addMethod("url", function (value, element) {
		var regex = /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/;
		return this.optional(element) || (regex.test(value));
	}, "");


	//验证长度
	jQuery.validator.addMethod("money", function (value, element) {
		var regex = /^(\d(\.\d{1,4})?|([1-9][0-9]{1,8})(\.\d{1,4})?)$/;;
		return this.optional(element) || (regex.test(value));
	}, "");

	//验证整数位
	jQuery.validator.addMethod("intlength", function (value, element) {
		var intnum ;
		if(value.indexOf(".")>=0){
			intnum = value.split(".")[0].length;
		}else{
			intnum = value.length;
		}
		var length = $.isArray( intnum ) ? intnum.length : this.getLength($.trim(intnum), element);
		return this.optional(element) || (length <= 9);
	}, "");

	//验证长度
	jQuery.validator.addMethod("stock", function (value, element, param) {
		var regex = /^100$|^(\d|[1-9]\d)(\.\d{1,4})*$/;
		return this.optional(element) || (regex.test(value));
	}, "");

	$("input[name='projectContribution']").bind("input propertychange", function() {
		var value=$(this).val();
		var intnum ;
		var decimalnum;
		if(value.indexOf(".")>=0){
			intnum = value.split(".")[0].length;
			decimalnum = value.split(".")[1].length;
		}else{
			intnum = value.length;
		}
		if(intnum>9){
			$(this).val($(this).val().substr(0,9));
			return;
		}
		if(decimalnum>4){
			$(this).val($(this).val().substr(0,14));
		}
	});

	$.fn.serializeJson = function(){
		var data = {};
		var array = this.serializeArray();
		$.each(array,function(){
			data[this.name]=this.value.replace(/(^\s+)|(\s+$)/g,"");
		})
		return data;
	}

	$("#projLogo").fileupload({
		url:publicsea.upload,
		formData:{},
		add: function (e, data) {
			var acceptFileTypes = /\/(jpg|jpeg|png|gif)$/i;
			if(data.originalFiles[0]['type'].length && !acceptFileTypes.test(data.originalFiles[0]['type'])) {
				$("#projLogoName").html("<font color='red'>*您的文件格式不正确</font>")
				return;
			}
			if(data.files[0].size > 500*1024*1024){
				$("#projLogoName").html("<font color='red'>*您的文件大小超过限制，请控制在500KB之内</font>")
				return;
			}
			$("#projLogoName").html(data.files[0].name);
            data.submit();
        },
        messages: {
			maxFileSize: 'File exceeds maximum allowed size of 5b'
		},
		done: function (e, data) {
			if(data.result.msg)
			{
				$("input[name='projectLogo']").val(data.result.uploadFiles[0].url)
			}
			else
			{
				$("#projLogoName").text(data.result.msg);
			}
		}
	});
	$("#projPb").fileupload({
		url:publicsea.upload,
		formData:{},
		add: function (e, data) {
			if(data.files[0].size > 25*1024*1024){
				$("#projPbName").text("上传商业计划书，文件大小请限制在25M之内")
				$("#projPbName").addClass("red")
				return;
			}
			$("#projPbName").text("正在上传文件...")
			$("#projPbName").removeClass("red");
			$('.person-upload-bp').removeClass('uploadBtnDanger');

            data.submit();
        },
		done: function (e, data) {
			if(data.result.msg)
			{
				$("#projPbName").removeClass("red");
				$('.person-upload-bp').removeClass('uploadBtnDanger');
				$("#projPbName").text(data.result.uploadFiles[0].fileName);
				$("input[name='fileName']").val(data.result.uploadFiles[0].fileName)
				$("input[name='fileKey']").val(data.result.uploadFiles[0].fileUploadName)
				$("input[name='fileUrl']").val(data.result.uploadFiles[0].url)
				$("input[name='fileSize']").val(data.result.uploadFiles[0].fileLength)
			}
			else
			{
				$("#projPbName").text(data.result.msg);
			}
		}
	});
</script>
<script>
function back(){

}
function save(){
		var area1Name =  $("select[name='area1']").find("option:selected").text();
		var area2Name =  $("select[name='area2']").find("option:selected").text();
		$("input[name='area1Name']").val(area1Name)
		$("input[name='area2Name']").val(area2Name)

		if($("select[name='industry1']").val()){
			var industry1Name =  $("select[name='industry1']").find("option:selected").text();
			$("input[name='industry1Name']").val(industry1Name)
		}

		if($("select[name='industry2']").val()){
			var industry2Name =  $("select[name='industry2']").find("option:selected").text();
			$("input[name='industry2Name']").val(industry2Name)
		}

		if($("select[name='projectLunci']").val()){
			var projectLunciTxt =  $("select[name='projectLunci']").find("option:selected").text();
			$("input[name='projectLunciTxt']").val(projectLunciTxt)
		}
		var url =publicsea.editProject
			var data = JSON.stringify($("#form").serializeJson());
			$.ajax({
				type: "POST",
				url:url,
				contentType:'application/json;charset=UTF-8',
				data:data,
				success:function(data){
					if(data.success)
					{
						location.href="person_center_myproject.html"
					}
					else
					{
						layer.msg("项目提交失败,请稍后再试!");
					}
				}
			})
}
$('body').delegate('#save-btn','click', function(event){
 	event.stopPropagation();
	$("#form").submit();
})
	var list ={};
	sendGetRequest(publicsea.comQuery,function(data){
		list["district"] = data["area"];
		list["industry"] = data["industry"];
		list["round"] = data["round"];
	});
	var parents = $("select[data-item='parent']");
	$.each(parents,function(){
		var parent = $(this);
		var field =  parent.attr("data-field");
		var data  = list[field];
		var html = ""
		$.each(data,function(i,e){
			html += "<option value ="+e.dictValue+" >"+e.dictName+"</option>"
		})
		parent.append(html);
	})

	$("select[name='area1']").change(function(){
		var parent = $(this);
		var son =$("select[name='area2']")
		getOption(parent,son,null)
	})

	$("select[name='industry1']").change(function(){
		var parent = $(this);
		var son =$("select[name='industry2']")
		getOption(parent,son,null)
	})

	function getOption(parent,son,id){
		// 先清空二级
		son.empty();
		var field=parent.attr("data-field")
		var index;
		if(parent[0].selectedIndex ==0){
			index = 0;
		}else{
			index= parent[0].selectedIndex-1
		}
		var parentData = list[field][index];
		var data =parentData.child;
		var html = ""
		son.val(data[0].dictValue)
		$.each(data,function(i,e){
			if(id && id == e.dictValue){
				html += "<option value ="+e.dictValue+" selected='selected' >"+e.dictName+"</option>"
			}else{
				html += "<option value ="+e.dictValue+" >"+e.dictName+"</option>"
			}
		})
		son.append(html);
		son.click();
	}
</script>
<script>
	var projectId =getHrefParamter("projectId");
	sendPostRequestByJsonObj(publicsea.queryProjectById,{"projectId":projectId},function(data){
		var ls = $("#form").find("*[name]");
		var entity = data.data[0]
		$(ls).each(function(i,e){
			var tagName = e.tagName;
			var value = entity[$(this).attr("name")]
			if(tagName == "INPUT" || tagName=="TEXTAREA"){
				$(this).val(value)
			}
			if(tagName=="SELECT" && ($(this).attr("data-item")=="parent")){
				$(this).find("option[value='"+value+"']").attr("selected",true);
			}
			if($(this).attr("name")=='area2'){
				if(value){
					getOption($("select[name='area1']"),$("select[name='area2']"),value)
				}else{
					getOption($("select[name='area1']"),$("select[name='area2']"),value)
				}
			}
			if($(this).attr("name")=='industry2'){
				if(value){
					getOption($("select[name='industry1']"),$("select[name='industry2']"),value)
				}
			}
		})
		if(entity["fileName"]){
			$("#projPbName").html(entity["fileName"])
		}
		if(entity["projectLogo"]){
			$("#projLogoName").html(entity["projectLogo"])
		}
	})
</script>
</html>
