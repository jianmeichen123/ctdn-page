<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>设置密码</title>
	<!--basis-->
	{(dn_basis.html)}
	<link rel='style/sheet'/>
	<style>
		#personmenu a:nth-child(4) li {color:#2393f7;}
		#personmenu a:nth-child(4) li span{background:url(../img/person_center/spirit_center.png) no-repeat -68px -140px;}
	</style>
</head>
<style>

</style>
<body>
{(header.html)}
<div class='person-center-container clearfix'>
	{(person_center_header.html)}
	<div class='person-right fl'>
		<div class='person-project-list person-reset-password' id="updatePass" style="display:none">
					<ul>
						<li>
							<span>旧密码</span>
							<input type='password' name="oldPass"  placeholder='请输入旧密码' onblur="func_blur(this)" onfocus="func_focus(this)"/>
							<span class='person-book-eye'></span>
							<label class='login-tips' name="oldPass_tip"></label>
						</li>
						<li>
							<span>新密码</span>
							<input type='password'  minlength="6" placeholder='请输入新密码' maxlength="30" name="password" />
							<span class='person-book-eye'></span>
							<label class='login-tips' name="password_tip"></label>
						</li>
						<li class='person-pass-confirm'>
							<span>确认密码</span>
							<input type='password' minlength="6" maxlength="14"  placeholder='请再次输入密码' name="confirmPassword" />
							<span class='person-book-eye'></span>
							<label class='login-tips' name="confirmPassword_tip"></label>
						</li>
						<span class='person-save-password' onclick="savePass(this)">保存密码</span>
					</ul>
		</div>
		<div class='person-project-list person-reset-password' id="setPass" style="display:none">
				<div class="password-content">
					<ul>
						<li>
							<span>设置密码</span>
							<input type='password' placeholder="请输入密码" name="password" minlength="6" maxlength="30" onblur="func_blur(this)" onfocus="func_focus(this)"/>
							<label class='login-tips' name="password_tip"></label>
							<span class='person-book-eye'></span>
						</li>
						<li class='person-pass-confirm new-confirm'>
							<span>确认密码</span>
							<input type='password' placeholder="请再次输入密码" name="confirmPassword" minlength="6" maxlength="30" onblur="func_blur(this)" onfocus="func_focus(this)"/>
							<label class='login-tips' name="confirmPassword_tip"></label>
							<span class='person-book-eye'></span>
						</li>
						
					</ul>
				</div>
				<span class='person-save-password' onclick="savePass(this)">保存密码</span>
		</div>
	</div>
</div>
 {(dn_foot.html)}
</body>
<script src="js/person_center_foot.js"></script>
<script src="js/jquery.validate.js"></script>
<script src="js/base64.js"></script>
<script src="js/messages_zh.min.js" type="text/javascript"></script>
<script>
var userOldPass;
var mobile;
if(getCookie("_uid_")){
        $.ajax({
		url :platformUrl.me,
		type : "GET",
		cache : false,
		contentType : "application/json; charset=UTF-8",
		async : false,
		error : function(request) {
		     location.href =  platformUrl.toLogin
		},
		success : function(data) {
			user_json = JSON.parse(decodeURIComponent(data))
			if(!user_json){
				location.href=  platformUrl.toLogin
				return
			}
			var ancientPWD = user_json['ancientPWD']
			userOldPass = ancientPWD;
			mobile = user_json['mobile']
			if(!ancientPWD){
				$("#setPass").show();
				$("#updatePass").hide();
			}else{
				$("#updatePass").show();
				$("#setPass").hide();
			}
		}
	});
}else{
	location.href =platformUrl.toLogin
}


function savePass(obj){
	var _this = $(obj);
	var div  = _this.closest("div[id]");
	 $('.login-tips').css('display','none');
	$('input').removeClass('inputDanger');
	$('input').removeClass('invalid');
	var passwordObj = div.find("input[name='password']")
	var password = passwordObj.val()
	var confirmPasswordObj = div.find("input[name='confirmPassword']")
	var confirmPassword = confirmPasswordObj.val()
	var confirmPassword_tip = div.find("label[name='confirmPassword']")
	var password_tip = div.find("label[name='password_tip']");

	if(div.find("input[name='oldPass']").length>0){
		var oldPassObj =  div.find("input[name='oldPass']")
		var oldPass = oldPassObj.val();
		var oldPass_tip = div.find("label[name='oldPass']")
		if(oldPass==null || oldPass.trim().length==0){
			oldPassObj.addClass('inputDanger');
			oldPassObj.addClass('invalid');
			return
		}
		var b = new Base64();
		if(b.encode(oldPass) != userOldPass){
			oldPassObj.addClass('inputDanger');
			oldPassObj.addClass('invalid');
			$('.login-tips').css("display","block");
			$('label[name="oldPass_tip"]').html('您输入的密码不正确~');
			
			return
		}
	}

	if(password==null || password.trim().length==0){
		passwordObj.addClass('inputDanger');
		passwordObj.addClass('invalid');
		return
	}
	if(!/^[0-9a-zA-Z]{6,30}$/.test(password)){
		passwordObj.addClass('inputDanger');
		passwordObj.addClass('invalid');
		password_tip.css('display','block').html('请输入6-30位的数字或字母作为密码~');
		password_tip.css("display","block")
		return
	}
	if(confirmPassword==null || confirmPassword.trim().length==0){
		confirmPasswordObj.addClass('inputDanger');
		confirmPasswordObj.addClass('invalid');
		confirmPassword_tip.css('display','block').html('请输入6-30位的数字或字母作为密码~');
		confirmPassword_tip.css('display','block');
		return
	}
	if(password != confirmPassword){
		confirmPasswordObj.addClass('inputDanger');
		confirmPasswordObj.addClass('invalid');
		passwordObj.addClass('inputDanger');
		passwordObj.addClass('invalid');
		$('label[name="confirmPassword_tip"]').html('两次密码输入不一致~');
		$('label[name="confirmPassword_tip"]').css('display','block');
		return
	}
	var callback = function(data){
		if(data.result.status == 'OK'){
			layer.msg('修改成功',{time:2000})
			window.location.href= platformUrl.toLogin
		}else{
		    layer.msg(data.result.message)
		}
	}
	var data = {
			mobile:mobile,
			password:password,
			confirmPassword:confirmPassword,
	}
	sendPostRequestByJsonObj(platformUrl.modifyPass,data,callback);
}

function func_blur(obj){
	var _this = $(obj);
	var val= $(obj).val()
	if(_this.hasClass('valid')){
		_this.removeClass('inputDanger');
		_this.removeClass('invalid');
	}
	if(val == null || val.trim().length==0){
		_this.addClass('inputDanger');
		_this.addClass('invalid');
	}
}
function func_focus(obj){
	var _this = $(obj);
	var name = _this.attr('name');
	$("label[name='"+name+"_tip']" ).attr('style','none')
	_this.removeClass('inputDanger');
	_this.removeClass('invalid');
}



$('.person-book-eye').click(function(){
	var _this = $(this);
	_this.toggleClass('person-book-eye-blue');	
	if(_this.hasClass('person-book-eye-blue')){
		_this.closest('li').find('input').attr('type','text');
	}else{
		_this.closest('li').find('input').attr('type','password');
	}
	
})



</script>
</html>